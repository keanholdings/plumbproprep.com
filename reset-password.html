<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reset Password — PlumbPro Exam</title>
<link rel="icon" type="image/png" href="images/logo.png">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Plus Jakarta Sans', -apple-system, sans-serif;
    background: #0E0E12;
    color: #F5F5F5;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }
  .card {
    max-width: 440px;
    width: 100%;
    background: #1A1A1E;
    border: 1px solid #35353A;
    border-radius: 24px;
    padding: 48px 32px;
    text-align: center;
  }
  .logo {
    width: 60px;
    height: 60px;
    border-radius: 14px;
    margin-bottom: 20px;
  }
  h1 {
    font-size: 24px;
    font-weight: 800;
    color: #F5F5F5;
    margin-bottom: 8px;
  }
  p {
    font-size: 15px;
    color: #9A9AA0;
    line-height: 1.6;
    margin-bottom: 24px;
  }
  .form-group {
    text-align: left;
    margin-bottom: 16px;
  }
  label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: #9A9AA0;
    margin-bottom: 6px;
  }
  input {
    width: 100%;
    padding: 14px 16px;
    background: #252529;
    border: 1px solid #35353A;
    border-radius: 12px;
    color: #F5F5F5;
    font-size: 16px;
    font-family: inherit;
    outline: none;
    transition: border-color 0.2s;
  }
  input:focus {
    border-color: #F2720C;
  }
  .btn {
    width: 100%;
    padding: 16px;
    background: #F2720C;
    color: #fff;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 700;
    font-family: inherit;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    margin-top: 8px;
  }
  .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 20px rgba(242, 114, 12, 0.2);
  }
  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  .error {
    background: rgba(231, 76, 60, 0.1);
    border: 1px solid rgba(231, 76, 60, 0.3);
    color: #E74C3C;
    padding: 12px;
    border-radius: 10px;
    font-size: 14px;
    margin-bottom: 16px;
    display: none;
  }
  .success {
    display: none;
  }
  .success .icon {
    font-size: 64px;
    margin-bottom: 16px;
  }
  .success h1 {
    color: #2ECC71;
  }
  .footer {
    margin-top: 24px;
    font-size: 12px;
    color: #5E5E66;
  }
  .footer a {
    color: #F2720C;
    text-decoration: none;
  }
  .password-req {
    font-size: 12px;
    color: #5E5E66;
    margin-top: 6px;
    text-align: left;
  }
</style>
</head>
<body>
  <div class="card">
    <img src="images/logo.png" alt="PlumbPro" class="logo">

    <!-- Reset Form -->
    <div id="resetForm">
      <h1>Reset Your Password</h1>
      <p>Enter your new password below.</p>

      <div class="error" id="errorMsg"></div>

      <div class="form-group">
        <label>New Password</label>
        <input type="password" id="password" placeholder="Enter new password" minlength="6">
        <div class="password-req">Must be at least 6 characters</div>
      </div>

      <div class="form-group">
        <label>Confirm Password</label>
        <input type="password" id="confirmPassword" placeholder="Confirm new password">
      </div>

      <button class="btn" id="submitBtn" onclick="resetPassword()">Update Password</button>
    </div>

    <!-- Success Message -->
    <div class="success" id="successMsg">
      <div class="icon">✅</div>
      <h1>Password Updated!</h1>
      <p>Your password has been reset successfully. Open the PlumbPro app and log in with your new password.</p>
    </div>

    <!-- No Token Message -->
    <div class="success" id="noTokenMsg">
      <div class="icon">⚠️</div>
      <h1 style="color: #F2720C;">Invalid or Expired Link</h1>
      <p>This password reset link has expired or is invalid. Please request a new password reset from the PlumbPro app.</p>
    </div>

    <div class="footer">
      Need help? <a href="mailto:support@plumbproprep.com">support@plumbproprep.com</a>
    </div>
  </div>

<script>
  // IMPORTANT: Replace these with your actual Supabase project URL and anon key
  const SUPABASE_URL = 'https://rggiitwitggspcbzhuru.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnZ2lpdHdpdGdnc3BjYnpodXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNDkxNTEsImV4cCI6MjA4NjYyNTE1MX0.5L_Jgqd1YavFi9yEQFB9nFCbpAdgkBXdGZwADCwO3Dg';

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let hasSession = false;

  // Check for auth token in URL hash
  async function init() {
    const hash = window.location.hash;
    if (hash && hash.includes('access_token')) {
      // Supabase auth callback - let it handle the session
      const { data, error } = await supabase.auth.getSession();
      if (data.session) {
        hasSession = true;
        document.getElementById('resetForm').style.display = 'block';
        document.getElementById('noTokenMsg').style.display = 'none';
      } else {
        showNoToken();
      }
    } else {
      // Try to get session from URL params (Supabase PKCE flow)
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      if (code) {
        const { data, error } = await supabase.auth.exchangeCodeForSession(code);
        if (data.session) {
          hasSession = true;
          document.getElementById('resetForm').style.display = 'block';
          document.getElementById('noTokenMsg').style.display = 'none';
        } else {
          showNoToken();
        }
      } else {
        showNoToken();
      }
    }
  }

  function showNoToken() {
    document.getElementById('resetForm').style.display = 'none';
    document.getElementById('noTokenMsg').style.display = 'block';
  }

  async function resetPassword() {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const errorEl = document.getElementById('errorMsg');
    const btn = document.getElementById('submitBtn');

    errorEl.style.display = 'none';

    if (password.length < 6) {
      errorEl.textContent = 'Password must be at least 6 characters.';
      errorEl.style.display = 'block';
      return;
    }

    if (password !== confirmPassword) {
      errorEl.textContent = 'Passwords do not match.';
      errorEl.style.display = 'block';
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Updating...';

    const { error } = await supabase.auth.updateUser({ password: password });

    if (error) {
      errorEl.textContent = error.message || 'Failed to update password. Please try again.';
      errorEl.style.display = 'block';
      btn.disabled = false;
      btn.textContent = 'Update Password';
    } else {
      document.getElementById('resetForm').style.display = 'none';
      document.getElementById('successMsg').style.display = 'block';
    }
  }

  // Handle enter key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') resetPassword();
  });

  init();
</script>
</body>
</html>
